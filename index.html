<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ilia Makeev | Data Scientist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="hero">
        <div class="hero-content">
            <h1 class="gradient-text">Ilia Makeev</h1>
            <div class="contact-info">
                <p><i class="fas fa-map-marker-alt"></i> Irvine, CA</p>
                <p><i class="fas fa-phone"></i> +1 (949) 279-2211</p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:il.makeev@gmail.com">il.makeev@gmail.com</a></p>
                <p><i class="fab fa-github"></i> <a href="https://github.com/MakeevIlia" target="_blank">GitHub</a></p>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="card summary">
            <h2><i class="fas fa-user-tie"></i> Professional Summary</h2>
            <p>Data Scientist with 5+ years of experience and dual Master’s degrees in Computer Science and Big Data Analysis. Skilled in machine learning, NLP, and high-performance computing, with expertise in Python, PyTorch, and model deployment.</p>
        </section>

        <section class="card skills">
            <h2><i class="fas fa-tools"></i> Technical Skills</h2>
            <div class="skills-grid">
                <div class="skill-category">
                    <h3>Machine Learning & Deep Learning</h3>
                    <div class="skill-tags">
                        <span>Python (scikit-learn, NumPy, Pandas)</span>
                        <span>PyTorch</span>
                    </div>
                </div>
                <div class="skill-category">
                    <h3>Cloud & Deployment</h3>
                    <div class="skill-tags">
                        <span>Flask</span>
                        <span>Docker</span>
                        <span>AWS</span>
                        <span>GCP</span>
                        <span>Git</span>
                    </div>
                </div>
                <div class="skill-category">
                    <h3>NLP & Statistical Analysis</h3>
                    <div class="skill-tags">
                        <span>spaCy</span>
                        <span>NLTK</span>
                        <span>Statistical Analysis</span>
                        <span>Hypothesis Testing</span>
                        <span>R</span>
                    </div>
                </div>
                <div class="skill-category">
                    <h3>Big Data & Visualization</h3>
                    <div class="skill-tags">
                        <span>Spark</span>
                        <span>Hadoop</span>
                        <span>SQL</span>
                        <span>Tableau</span>
                        <span>Matplotlib</span>
                        <span>Seaborn</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="card experience">
            <h2><i class="fas fa-briefcase"></i> Experience</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <h3>Research Assistant & Adjunct Professor</h3>
                    <p class="company">New Mexico Highlands University (Jan 2024 – Dec 2024)</p>
                    <ul>
                        <li>Conducted computational experiments using Python and C++ to model materials properties.</li>
                        <li>Optimized high-performance computing implementations, reducing simulation runtime by 80%.</li>
                        <li>Developed predictive models, improving lab efficiency by 53%.</li>
                        <li>Taught C++, Operating Systems, and Advanced Programming.</li>
                    </ul>
                </div>
                <div class="timeline-item">
                    <h3>Data Scientist</h3>
                    <p class="company">Yandex (Apr 2021 – Jan 2024)</p>
                    <ul>
                        <li>Built and deployed NLP models, improving lesson completion rates by 65%.</li>
                        <li>Engineered a recommendation system increasing lesson effectiveness by 60%.</li>
                        <li>Developed a Large Language Model, improving comprehension by 90%.</li>
                    </ul>
                </div>
                <div class="timeline-item">
                    <h3>Data Analyst</h3>
                    <p class="company">Yandex (Jun 2020 – Apr 2021)</p>
                    <ul>
                        <li>Cleaned and preprocessed large datasets, reducing inconsistencies by 68%.</li>
                        <li>Analyzed behavioral data, increasing student performance by 300%.</li>
                        <li>Designed and executed A/B tests to refine educational content.</li>
                    </ul>
                </div>
                <div class="timeline-item">
                    <h3>Author of Data Science Courses</h3>
                    <p class="company">Yandex (Mar 2019 – Jun 2020)</p>
                    <ul>
                        <li>Created and supervised 70+ lessons on statistics and data analysis.</li>
                        <li>Developed 500+ programming tasks and 100+ visual materials.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="card education">
            <h2><i class="fas fa-graduation-cap"></i> Education</h2>
            <ul>
                <li>M.S. in Computer Science, New Mexico Highlands University (GPA: 4.00/4.0)</li>
                <li>M.S. in Intelligent Analysis of Big Data, Lomonosov Moscow State University (GPA: 3.89/4.0)</li>
                <li>B.S. in Applied Mathematics, Bauman Moscow State Technical University (GPA: 3.78/4.0)</li>
            </ul>
        </section>

        <section class="card research">
            <h2><i class="fas fa-flask"></i> Research</h2>
            <ul>
                <h3>Original Time Series Forecasting Method</h3>
                    <ul>
                        <li>Developed a feature extraction method integrated with LSTM neural networks that increased forecasting accuracy by 20%, utilizing sliding window techniques and multivariate modeling to tackle complex data in climate science, stock price prediction, and medical data classification</li>
                    </ul>
                <h3>Regularized Estimation-Maximazition Algorithm</h3>
                    <ul>
                        <li>Researched the mathematical properties of the Expectation-Maximization (EM) algorithm, analyzing its convergence properties and introducing a Regularized EM approach based on maximizing Shannon’s Entropy. Demonstrated a 35% computing improvement over the original method</li>
                    </ul>
                <h3>Analysis of Erdos-Renyi Random Graphs</h3>
                    <ul>
                        <li>Analyzed random graph indicators’ convergence to the standard normal distribution, developed algorithms for convergence rates and error bounds, and achieved a 450% boost in computational efficiency</li>
                    </ul>
                
            </ul>
        </section>

        <section class="card certifications">
            <h2><i class="fas fa-certificate"></i> Certifications</h2>
            <ul>
                <li>Neural Networks & Computer Vision (Samsung AI Centre): Fine-tuned a CNN model (ResNet-18) to classify images using PyTorch on GPU.</li>
                <li>Neural Networks & Text Processing (Samsung AI Centre): Developed a text-based semantics analysis model using SVM with Scikit-Learn.</li>
            </ul>
        </section>
    </main>
</body>
</html>
 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meeting Bingo</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --tick:#16a34a; --tile:#1f2937; --tile-checked:#10b98122; --tile-stroke:#374151; --tile-win:#10b98155;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  h1{margin:8px 0 16px;font-size:28px}
  h2{margin:18px 0 8px;font-size:18px;color:var(--muted);font-weight:600}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px;min-width:240px}
  textarea, input, select {width:100%;box-sizing:border-box;background:#0b1220;color:var(--ink);border:1px solid #223;outline:none;border-radius:10px;padding:10px;font-size:14px}
  textarea{min-height:140px;resize:vertical}
  label{display:block;margin:6px 0 6px;color:var(--muted);font-size:13px}
  .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;background:#1f2937;color:#fff;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:var(--accent);color:#06210f}
  .btn.ghost{background:#0b1220}
  .btn.warn{background:var(--warn);color:#2b1b00}
  .btn.err{background:var(--err)}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .note{color:var(--muted);font-size:13px}
  .error{color:var(--err);font-weight:600}
  .success{color:var(--accent);font-weight:600}
  /* Board */
  .board {display:grid;gap:10px;margin-top:16px}
  .tile{user-select:none;-webkit-tap-highlight-color:transparent; background:var(--tile); border:1px solid var(--tile-stroke); border-radius:14px; padding:10px;
        display:flex; align-items:center; justify-content:center; text-align:center; min-height:72px; line-height:1.25; font-size:14px; cursor:pointer}
  .tile.checked{background:var(--tile-checked); border-color:var(--accent); box-shadow:inset 0 0 0 2px var(--accent)}
  .tile.win { box-shadow:0 0 0 3px var(--accent), inset 0 0 0 2px var(--accent); }
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .spacer{flex:1}
  .pill{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0b1220;border:1px solid #223;padding:2px 6px;border-radius:6px;color:#cbd5e1}
  .footer{margin:20px 0;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">

  <div id="view-setup" class="card" hidden>
    <h1>Meeting Bingo — Setup</h1>
    <p class="note">Paste each event on a new line. These lists are encoded into the share link—no server needed.</p>

    <div class="row">
      <div class="col">
        <h2>Often</h2>
        <textarea id="oftenTxt"></textarea>
        <label><span>Count to place from “Often”</span>
          <input id="countOften" type="number" min="0" step="1" value="12">
        </label>
      </div>
      <div class="col">
        <h2>Medium</h2>
        <textarea id="mediumTxt"></textarea>
        <label><span>Count to place from “Medium”</span>
          <input id="countMedium" type="number" min="0" step="1" value="8">
        </label>
      </div>
      <div class="col">
        <h2>Rare</h2>
        <textarea id="rareTxt"></textarea>
        <label><span>Count to place from “Rare”</span>
          <input id="countRare" type="number" min="0" step="1" value="5">
        </label>
      </div>
    </div>

    <div class="row card">
      <div class="col">
        <label>Board size (NxN)
          <input id="boardSize" type="number" min="3" max="7" value="5">
        </label>
        <label><input id="freeCenter" type="checkbox"> Use free center tile</label>
        <div class="note">Counts must sum to <span id="needCells">25</span>. Use <span class="kbd">Auto-fit</span> to fix.</div>
      </div>
      <div class="col">
        <label>Board Title (optional)
          <input id="boardTitle" type="text" placeholder="e.g., Team Stand-Up Bingo">
        </label>
        <label>Host name (optional)
          <input id="hostName" type="text" placeholder="e.g., Ilia">
        </label>
      </div>
      <div class="col">
        <h2>Actions</h2>
        <div class="btn-row">
          <button class="btn warn" id="btnAutofit" type="button">Auto-fit counts</button>
          <button class="btn ghost" id="btnResetToDefaults" type="button">Reset to defaults</button>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn primary" id="btnMakeLink" type="button">Copy link for everyone</button>
      <button class="btn" id="btnPreviewBoard" type="button">Open board here</button>
      <button class="btn ghost" id="btnExport" type="button">Export JSON</button>
      <button class="btn ghost" id="btnImport" type="button">Import JSON</button>
      <span id="status" class="pill"></span>
    </div>
  </div>

  <div id="view-board" class="card" hidden>
    <div class="toolbar">
      <div>
        <h1 id="titleBoard">Meeting Bingo</h1>
        <div class="pill" id="subtitle"></div>
      </div>
      <div class="spacer"></div>
      <div class="btn-row">
        <button class="btn" id="btnNewBoard" type="button" title="Create a new random board for yourself">New board</button>
        <button class="btn" id="btnClearMarks" type="button" title="Uncheck all tiles">Reset marks</button>
        <button class="btn ghost" id="btnCopyGameLink" type="button" title="Share the game link (others get their own random boards)">Copy game link</button>
        <button class="btn ghost" id="btnGoSetup" type="button">Setup</button>
      </div>
    </div>

    <div id="warnBox" class="pill"></div>
    <div id="board" class="board"></div>

    <div class="footer">
      Pro tip: each player taps <b>New board</b> if they want to reshuffle. Your marks are saved on your device.
    </div>
  </div>

</div>

<script>
/* ---------- Utilities (UTF-8 safe Base64) ---------- */
const utf8ToB64 = (str) => btoa(unescape(encodeURIComponent(str)));
const b64ToUtf8 = (str) => decodeURIComponent(escape(atob(str)));

function sampleWithoutReplacement(arr, n, rng) {
  const a = arr.slice();
  // Fisher-Yates with seeded RNG
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a.slice(0, Math.min(n, a.length));
}

function seededRNG(seed) {
  // Mulberry32
  let h = 0;
  for (let i = 0; i < seed.length; i++) {
    h = Math.imul(31, h) + seed.charCodeAt(i) | 0;
  }
  let t = h >>> 0;
  return function() {
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}

function uuid() {
  const a = crypto.getRandomValues(new Uint8Array(16));
  a[6] = (a[6] & 0x0f) | 0x40; // version 4
  a[8] = (a[8] & 0x3f) | 0x80;
  return [...a].map((b,i)=>([4,6,8,10].includes(i)?'-':'') + b.toString(16).padStart(2,'0')).join('');
}

function byId(id){return document.getElementById(id);}
function textLines(v){ return v.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

/* ---------- Routing ---------- */
function showSetup(){ byId('view-setup').hidden=false; byId('view-board').hidden=true; }
function showBoard(){ byId('view-setup').hidden=true; byId('view-board').hidden=false; }

/* ---------- Defaults (your lists pre-filled) ---------- */
const DEFAULTS = {
  size: 5,
  freeCenter: false,
  title: 'Meeting Bingo',
  host: '',
  events: {
    often: [
      "Жена Ленина",
      "Да помолчи (Сергей Андрею)",
      "Лариса Андрею: потише",
      "Без пузыря",
      "Историческая минутка",
      "Знаете из какого это фильма?",
      "На работе нет денег",
      "Младший из помёта",
      "Андрей/Лариса поправляет челку"
    ],
    medium: [
      "Ремонт (все время на проекте) + посмотрели сериал",
      "Лариса Андрею: слезь с бронивика",
      "Мы с Ильей что-то сделали не так",
      "Лариса и Андрей: в России хорошо",
      "Рандомный вопрос от Ларисы для беседы",
      "История про торт от Ларисы",
      "Похвала еды (много)"
    ],
    rare: [
      "Вопрос про Катину работу",
      "Мотоцикл для Кати",
      "Вопрос про Жору",
      "Саша и Катя не так одеты",
      "Вопрос про вонючую воду",
      "Говнюшка про бабулю/дедулю",
      "Лариса про ногти",
      "Проебали рейс",
      "Пердёж про музеи",
      "Грузинский ресторан",
      "Приглашать Сашу и Катю в колледж"
    ]
  },
  counts: { often:12, medium:8, rare:5 }
};

/* ---------- Setup view logic ---------- */
function readSetup() {
  const size = Math.max(3, Math.min(7, parseInt(byId('boardSize').value||'5',10)));
  const freeCenter = byId('freeCenter').checked;
  const title = byId('boardTitle').value.trim() || 'Meeting Bingo';
  const host = byId('hostName').value.trim();

  const events = {
    often: textLines(byId('oftenTxt').value),
    medium: textLines(byId('mediumTxt').value),
    rare: textLines(byId('rareTxt').value),
  };
  const counts = {
    often: Math.max(0, parseInt(byId('countOften').value||'0',10)),
    medium: Math.max(0, parseInt(byId('countMedium').value||'0',10)),
    rare: Math.max(0, parseInt(byId('countRare').value||'0',10)),
  };
  return { size, freeCenter, title, host, events, counts };
}

function writeSetup(cfg){
  byId('boardSize').value = cfg.size;
  byId('freeCenter').checked = !!cfg.freeCenter;
  byId('boardTitle').value = cfg.title || '';
  byId('hostName').value = cfg.host || '';
  byId('oftenTxt').value = (cfg.events.often||[]).join('\n');
  byId('mediumTxt').value = (cfg.events.medium||[]).join('\n');
  byId('rareTxt').value = (cfg.events.rare||[]).join('\n');
  byId('countOften').value = cfg.counts.often ?? 0;
  byId('countMedium').value = cfg.counts.medium ?? 0;
  byId('countRare').value = cfg.counts.rare ?? 0;
  updateNeedCells();
}

function updateNeedCells(){
  const n = parseInt(byId('boardSize').value||'5',10);
  const freeCenter = byId('freeCenter').checked;
  const totalCells = n*n - (freeCenter && n%2===1 ? 1 : 0);
  byId('needCells').textContent = String(totalCells);
}

function validateCounts(cfg){
  const n = cfg.size;
  const freeCtr = cfg.freeCenter && n%2===1 ? 1 : 0;
  const need = n*n - freeCtr;
  const have = cfg.counts.often + cfg.counts.medium + cfg.counts.rare;
  if (have !== need) {
    throw new Error(`Counts must sum to ${need}, but got ${have}. Use Auto-fit or adjust manually.`);
  }
  // Ensure enough unique items total (we won’t duplicate unless forced)
  const totalUnique = new Set([
    ...cfg.events.often, ...cfg.events.medium, ...cfg.events.rare
  ]).size;
  if (totalUnique < need) {
    throw new Error(`Not enough unique events (${totalUnique}) to fill ${need} cells. Add more lines or reduce counts.`);
  }
  // Category-specific availability warnings (not fatal; we’ll clamp later if needed)
  const warns = [];
  for (const k of ['often','medium','rare']) {
    if ((cfg.events[k]||[]).length < cfg.counts[k]) {
      warns.push(`Category “${k}” needs ${cfg.counts[k]} but has only ${cfg.events[k].length}.`);
    }
  }
  return warns;
}

function autoFitCounts(){
  const size = Math.max(3, Math.min(7, parseInt(byId('boardSize').value||'5',10)));
  const freeCenter = byId('freeCenter').checked && (size%2===1);
  const need = size*size - (freeCenter ? 1 : 0);
  // Defaults weight: often 12, medium 8, rare 5 for 25 → weights 12/25, 8/25, 5/25
  const w = {often:12, medium:8, rare:5};
  const scale = need/25;
  let counts = {
    often: Math.max(0, Math.round(w.often*scale)),
    medium: Math.max(0, Math.round(w.medium*scale)),
    rare: Math.max(0, Math.round(w.rare*scale))
  };
  // fix rounding drift
  let sum = counts.often + counts.medium + counts.rare;
  while (sum !== need) {
    const order = ['often','medium','rare'];
    const k = order[(Math.abs(need-sum)) % 3];
    if (sum < need) counts[k]++; else if (counts[k]>0) counts[k]--;
    sum = counts.often + counts.medium + counts.rare;
  }
  byId('countOften').value = counts.often;
  byId('countMedium').value = counts.medium;
  byId('countRare').value = counts.rare;
}

function configToLink(cfg, withSeed){
  const payload = { v:1, ...cfg };
  const cfgB64 = utf8ToB64(JSON.stringify(payload));
  let url = location.origin + location.pathname + '#/board?cfg=' + encodeURIComponent(cfgB64);
  if (withSeed) {
    const seed = uuid();
    url += '&seed=' + encodeURIComponent(seed);
  }
  return url;
}

function parseHashQuery() {
  // Expect like #/board?cfg=...&seed=...
  const hash = location.hash || '';
  const qidx = hash.indexOf('?');
  let route = hash.slice(1, qidx === -1 ? undefined : qidx);
  if (!route) route = '/setup';
  const params = new URLSearchParams(qidx===-1 ? '' : hash.slice(qidx+1));
  return {route, params};
}

/* ---------- Board generation ---------- */
function buildBoard(cfg, seed) {
  const rng = seededRNG(String(seed||'seed'));
  const N = cfg.size;
  const freeCenter = cfg.freeCenter && (N%2===1);
  const need = N*N - (freeCenter?1:0);

  // Clamp each category to availability (we warn earlier)
  const pickOften  = sampleWithoutReplacement(cfg.events.often,  cfg.counts.often,  rng);
  const pickMedium = sampleWithoutReplacement(cfg.events.medium, cfg.counts.medium, rng);
  const pickRare   = sampleWithoutReplacement(cfg.events.rare,   cfg.counts.rare,   rng);
  let pool = [...pickOften, ...pickMedium, ...pickRare];

  // If some category lacked items (pool smaller than need), fill from remaining unique items
  if (pool.length < need) {
    const all = [...new Set([...cfg.events.often, ...cfg.events.medium, ...cfg.events.rare])];
    const unused = all.filter(x => !pool.includes(x));
    // shuffle unused with rng
    for (let i = unused.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [unused[i], unused[j]] = [unused[j], unused[i]];
    }
    pool = pool.concat(unused.slice(0, need - pool.length));
  }
  // Final shuffle
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }

  // Insert FREE center if enabled
  const cells = [];
  let idx = 0;
  for (let r=0;r<N;r++){
    for (let c=0;c<N;c++){
      if (freeCenter && r===Math.floor(N/2) && c===Math.floor(N/2)) {
        cells.push({text:'FREE', free:true});
      } else {
        cells.push({text: pool[idx++] || ''});
      }
    }
  }
  return cells;
}

function storageKey(cfgHash, seed){ return `bingo:${cfgHash}:seed:${seed}:marks`; }
function hashStr(s){
  let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return String(h>>>0);
}

function renderBoard(cfg, seed){
  const boardEl = byId('board');
  const titleEl = byId('titleBoard');
  const subEl = byId('subtitle');
  const warnEl = byId('warnBox');

  // grid
  boardEl.style.gridTemplateColumns = `repeat(${cfg.size}, 1fr)`;

  titleEl.textContent = cfg.title || 'Meeting Bingo';
  const parts = [];
  if (cfg.host) parts.push(`Host: ${cfg.host}`);
  parts.push(`Board: ${cfg.size}×${cfg.size}${cfg.freeCenter && cfg.size%2===1 ? ', free center' : ''}`);
  subEl.textContent = parts.join(' · ');

  // warnings already checked at setup; still show soft note if needed
  warnEl.textContent = '';
  const softs = [];
  if (cfg.events.often.length < cfg.counts.often)  softs.push(`“Often” short by ${cfg.counts.often - cfg.events.often.length}`);
  if (cfg.events.medium.length < cfg.counts.medium)softs.push(`“Medium” short by ${cfg.counts.medium - cfg.events.medium.length}`);
  if (cfg.events.rare.length < cfg.counts.rare)    softs.push(`“Rare” short by ${cfg.counts.rare - cfg.events.rare.length}`);
  if (softs.length) warnEl.textContent = 'Heads-up: ' + softs.join('; ') + '. Filled with other unique items.';

  const cells = buildBoard(cfg, seed);
  const cfgHash = hashStr(JSON.stringify(cfg));
  const key = storageKey(cfgHash, seed);
  let marks = {};
  try { marks = JSON.parse(localStorage.getItem(key)||'{}') } catch { marks = {}; }

  boardEl.innerHTML = '';
  cells.forEach((cell, i)=>{
    const d = document.createElement('div');
    d.className = 'tile';
    d.setAttribute('role','button');
    d.setAttribute('aria-pressed', marks[i] ? 'true' : 'false');
    d.textContent = cell.text;
    if (cell.free) {
      d.classList.add('checked');
      d.classList.add('win'); // highlight FREE a bit
      marks[i] = true;
    } else if (marks[i]) {
      d.classList.add('checked');
    }
    d.addEventListener('click', ()=>{
      const now = d.classList.toggle('checked');
      d.setAttribute('aria-pressed', now ? 'true' : 'false');
      marks[i] = now;
      localStorage.setItem(key, JSON.stringify(marks));
      updateWinLines(boardEl, cfg.size);
    }, {passive:true});
    boardEl.appendChild(d);
  });
  updateWinLines(boardEl, cfg.size);
}

function updateWinLines(boardEl, N){
  // simple bingo detection; add .win to tiles in any full row/col/diagonal
  const tiles = [...boardEl.querySelectorAll('.tile')];
  const idx = (r,c)=> r*N + c;
  // clear wins
  tiles.forEach(t => t.classList.remove('win'));
  const lines = [];
  // rows
  for (let r=0;r<N;r++){
    const row = Array.from({length:N}, (_,c)=>idx(r,c));
    if (row.every(i=>tiles[i].classList.contains('checked'))) lines.push(row);
  }
  // cols
  for (let c=0;c<N;c++){
    const col = Array.from({length:N}, (_,r)=>idx(r,c));
    if (col.every(i=>tiles[i].classList.contains('checked'))) lines.push(col);
  }
  // diagonals
  const d1 = Array.from({length:N}, (_,k)=>idx(k,k));
  const d2 = Array.from({length:N}, (_,k)=>idx(k,N-1-k));
  if (d1.every(i=>tiles[i].classList.contains('checked'))) lines.push(d1);
  if (d2.every(i=>tiles[i].classList.contains('checked'))) lines.push(d2);

  lines.forEach(line => line.forEach(i=>tiles[i].classList.add('win')));
}

/* ---------- View wiring ---------- */
function toSetup(){
  history.replaceState(null, '', location.pathname + '#/setup');
  showSetup();
}

function toBoard(cfg, seed){
  const cfgB64 = utf8ToB64(JSON.stringify({v:1, ...cfg}));
  const qs = new URLSearchParams();
  qs.set('cfg', cfgB64);
  if (seed) qs.set('seed', seed);
  history.replaceState(null, '', location.pathname + '#/board?' + qs.toString());
  showBoard();
  renderBoard(cfg, seed || ensureSeedInUrl());
}

function ensureSeedInUrl(){
  const {params} = parseHashQuery();
  let seed = params.get('seed');
  if (!seed) {
    seed = uuid();
    params.set('seed', seed);
    history.replaceState(null, '', location.pathname + '#/board?' + params.toString());
  }
  return seed;
}

function loadConfigFromHash(){
  const {params} = parseHashQuery();
  const cfgStr = params.get('cfg');
  if (!cfgStr) return null;
  try {
    const cfg = JSON.parse(b64ToUtf8(cfgStr));
    if (!cfg || cfg.v !== 1) return null;
    // basic normalization
    cfg.size = Math.max(3, Math.min(7, parseInt(cfg.size||5,10)));
    cfg.freeCenter = !!cfg.freeCenter;
    cfg.title = cfg.title || 'Meeting Bingo';
    cfg.host = cfg.host || '';
    cfg.events = cfg.events || {often:[],medium:[],rare:[]};
    cfg.counts = cfg.counts || {often:0,medium:0,rare:0};
    return cfg;
  } catch {
    return null;
  }
}

/* ---------- Buttons & Init ---------- */
function bindSetupHandlers(){
  const status = byId('status');
  function flash(msg, ok=true){
    status.textContent = msg;
    status.className = 'pill ' + (ok ? 'success' : 'error');
    setTimeout(()=>{ status.textContent=''; status.className='pill'; }, 2500);
  }

  byId('boardSize').addEventListener('input', updateNeedCells);
  byId('freeCenter').addEventListener('change', updateNeedCells);

  byId('btnAutofit').addEventListener('click', ()=>{
    autoFitCounts();
    flash('Counts auto-fit.');
  });

  byId('btnResetToDefaults').addEventListener('click', ()=>{
    writeSetup(DEFAULTS);
    flash('Defaults restored.');
  });

  byId('btnExport').addEventListener('click', ()=>{
    const cfg = readSetup();
    const payload = JSON.stringify({v:1, ...cfg}, null, 2);
    navigator.clipboard.writeText(payload).then(()=>flash('Config JSON copied.'));
  });

  byId('btnImport').addEventListener('click', async ()=>{
    const txt = prompt('Paste config JSON:');
    if (!txt) return;
    try{
      const obj = JSON.parse(txt);
      if (!obj || obj.v !== 1) throw new Error('Bad version.');
      writeSetup(obj);
      flash('Config imported.');
    }catch(e){
      flash('Import failed: ' + e.message, false);
    }
  });

  byId('btnMakeLink').addEventListener('click', ()=>{
    try{
      const cfg = readSetup();
      const warns = validateCounts(cfg);
      const url = configToLink(cfg, false);
      navigator.clipboard.writeText(url).then(()=>{
        flash('Share link copied!');
      });
      if (warns.length) flash('Note: ' + warns.join(' '), true);
    }catch(e){
      flash(e.message, false);
    }
  });

  byId('btnPreviewBoard').addEventListener('click', ()=>{
    try{
      const cfg = readSetup();
      const warns = validateCounts(cfg);
      toBoard(cfg, null); // will add random seed
      const statusBox = byId('warnBox');
      if (warns.length) statusBox.textContent = 'Heads-up: ' + warns.join(' ');
    }catch(e){
      alert(e.message);
    }
  });
}

function bindBoardHandlers(){
  byId('btnGoSetup').addEventListener('click', toSetup);

  byId('btnCopyGameLink').addEventListener('click', ()=>{
    const cfg = loadConfigFromHash();
    if (!cfg) { alert('No config found in link.'); return; }
    const url = configToLink(cfg, false);
    navigator.clipboard.writeText(url).then(()=>{ /* ok */ });
  });

  byId('btnNewBoard').addEventListener('click', ()=>{
    const cfg = loadConfigFromHash();
    if (!cfg) return toSetup();
    const seed = uuid();
    const {params} = parseHashQuery();
    params.set('seed', seed);
    history.replaceState(null, '', location.pathname + '#/board?' + params.toString());
    renderBoard(cfg, seed);
  });

  byId('btnClearMarks').addEventListener('click', ()=>{
    const cfg = loadConfigFromHash();
    const {params} = parseHashQuery();
    if (!cfg) return;
    const seed = params.get('seed') || ensureSeedInUrl();
    const key = storageKey(hashStr(JSON.stringify(cfg)), seed);
    localStorage.removeItem(key);
    renderBoard(cfg, seed);
  });
}

function boot(){
  bindSetupHandlers();
  bindBoardHandlers();

  const route = parseHashQuery().route;
  if (route.startsWith('/board')) {
    const cfg = loadConfigFromHash();
    if (!cfg) {
      // No config in URL → fall back to setup with defaults loaded
      showSetup();
      writeSetup(DEFAULTS);
      return;
    }
    showBoard();
    byId('titleBoard').textContent = cfg.title || 'Meeting Bingo';
    renderBoard(cfg, ensureSeedInUrl());
  } else {
    showSetup();
    writeSetup(DEFAULTS);
  }
}

window.addEventListener('hashchange', boot);
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
